C51 COMPILER V9.01   HC_SR04                                                               09/18/2021 08:55:27 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE HC_SR04
OBJECT MODULE PLACED IN HC-SR04.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE HC-SR04.c OMF2 BROWSE DEBUG TABS(2)

line level    source

   1          //è¶…å£°æ³¢æµ‹è·
   2          //æ™¶æŒ¯=8M
   3          //MCU=STC10F04XE
   4          //P0.0-P0.6å…±é˜³æ•°ç ç®¡å¼•è„š
   5          //Trig  = P1^0
   6          //Echo  = P3^2
   7          #include <reg52.h>     //åŒ…æ‹¬ä¸€ä¸ª52æ ‡å‡†å†…æ ¸çš„å¤´æ–‡ä»¶
   8          #define uchar unsigned char //å®šä¹‰ä¸€ä¸‹æ–¹ä¾¿ä½¿ç”¨
   9          #define uint  unsigned int
  10          #define ulong unsigned long
  11          //***********************************************
  12          sfr  CLK_DIV = 0x97; //ä¸ºSTCå•ç‰‡æœºå®šä¹‰,ç³»ç»Ÿæ—¶é’Ÿåˆ†é¢‘
  13                               //ä¸ºSTCå•ç‰‡æœºçš„IOå£è®¾ç½®åœ°å€å®šä¹‰
  14          sfr   P0M1   = 0X93;
  15          sfr   P0M0   = 0X94;
  16          sfr   P1M1   = 0X91;
  17          sfr   P1M0   = 0X92;
  18          sfr P2M1   = 0X95;
  19          sfr P2M0   = 0X96;
  20          //***********************************************
  21          sbit Trig  = P1^0; //äº§ç”Ÿè„‰å†²å¼•è„š
  22          sbit Echo  = P3^2; //å›æ³¢å¼•è„š
  23          sbit test  = P1^1; //æµ‹è¯•ç”¨å¼•è„š
  24          
  25          uchar code SEG7[10]={0xC0,0xF9,0xA4,0xB0,0x99,0x92,0x82,0xF8,0x80,0x90};//æ•°ç ç®¡0-9
  26          uint distance[4];  //æµ‹è·æ¥æ”¶ç¼“å†²åŒº
  27          uchar ge,shi,bai,temp,flag,outcomeH,outcomeL,i;  //è‡ªå®šä¹‰å¯„å­˜å™¨
  28          bit succeed_flag;  //æµ‹é‡æˆåŠŸæ ‡å¿—
  29          //********å‡½æ•°å£°æ˜
  30          void conversion(uint temp_data);
  31          void delay_20us();
  32          //void pai_xu();
  33          
  34          void main(void)   // ä¸»ç¨‹åº
  35          {  uint distance_data,a,b;
  36   1         uchar CONT_1;   
  37   1         CLK_DIV=0X03; //ç³»ç»Ÿæ—¶é’Ÿä¸º1/8æ™¶æŒ¯ï¼ˆpdf-45é¡µï¼‰ 
  38   1           P0M1 = 0;   //å°†ioå£è®¾ç½®ä¸ºæ¨æŒ½è¾“å‡º
  39   1           P1M1 = 0;
  40   1           P2M1 = 0;
  41   1           P0M0 = 0XFF;
  42   1           P1M0 = 0XFF;
  43   1           P2M0 = 0XFF;
  44   1         i=0;
  45   1         flag=0;
  46   1        test =0;
  47   1        Trig=0;       //é¦–å…ˆæ‹‰ä½è„‰å†²è¾“å…¥å¼•è„š
  48   1        TMOD=0x11;    //å®šæ—¶å™¨0ï¼Œå®šæ—¶å™¨1ï¼Œ16ä½å·¥ä½œæ–¹å¼
  49   1        TR0=1;       //å¯åŠ¨å®šæ—¶å™¨0
  50   1         IT0=0;        //ç”±é«˜ç”µå¹³å˜ä½ç”µå¹³ï¼Œè§¦å‘å¤–éƒ¨ä¸­æ–­
  51   1        ET0=1;        //æ‰“å¼€å®šæ—¶å™¨0ä¸­æ–­
  52   1       //ET1=1;        //æ‰“å¼€å®šæ—¶å™¨1ä¸­æ–­
  53   1        EX0=0;        //å…³é—­å¤–éƒ¨ä¸­æ–­
  54   1        EA=1;         //æ‰“å¼€æ€»ä¸­æ–­0  
  55   1        
C51 COMPILER V9.01   HC_SR04                                                               09/18/2021 08:55:27 PAGE 2   

  56   1        
  57   1      while(1)         //ç¨‹åºå¾ªç¯
  58   1        {
  59   2        EA=0;
  60   2             Trig=1;
  61   2              delay_20us();
  62   2              Trig=0;         //äº§ç”Ÿä¸€ä¸ª20usçš„è„‰å†²ï¼Œåœ¨Trigå¼•è„š  
  63   2              while(Echo==0); //ç­‰å¾…Echoå›æ³¢å¼•è„šå˜é«˜ç”µå¹³
  64   2             succeed_flag=0; //æ¸…æµ‹é‡æˆåŠŸæ ‡å¿—
  65   2             EX0=1;          //æ‰“å¼€å¤–éƒ¨ä¸­æ–­
  66   2            TH1=0;          //å®šæ—¶å™¨1æ¸…é›¶
  67   2              TL1=0;          //å®šæ—¶å™¨1æ¸…é›¶
  68   2             TF1=0;          //
  69   2              TR1=1;          //å¯åŠ¨å®šæ—¶å™¨1
  70   2         EA=1;
  71   2      
  72   2            while(TH1 < 30);//ç­‰å¾…æµ‹é‡çš„ç»“æœï¼Œå‘¨æœŸ65.535æ¯«ç§’ï¼ˆå¯ç”¨ä¸­æ–­å®ç°ï¼‰  
  73   2            TR1=0;          //å…³é—­å®šæ—¶å™¨1
  74   2              EX0=0;          //å…³é—­å¤–éƒ¨ä¸­æ–­
  75   2      
  76   2          if(succeed_flag==1)
  77   2             {  
  78   3             distance_data=outcomeH;                //æµ‹é‡ç»“æœçš„é«˜8ä½
  79   3                 distance_data<<=8;                   //æ”¾å…¥16ä½çš„é«˜8ä½
  80   3               distance_data=distance_data|outcomeL;//ä¸ä½8ä½åˆå¹¶æˆä¸º16ä½ç»“æœæ•°æ®
  81   3                  distance_data*=12;                  //å› ä¸ºå®šæ—¶å™¨é»˜è®¤ä¸º12åˆ†é¢‘
  82   3                 distance_data/=58;                   //å¾®ç§’çš„å•ä½é™¤ä»¥58ç­‰äºå˜ç±³
  83   3               }                                      //ä¸ºä»€ä¹ˆé™¤ä»¥58ç­‰äºå˜ç±³ï¼Œ  Yç±³=ï¼ˆXç§’*344ï¼‰/2
  84   2                                                   // Xç§’=ï¼ˆ 2*Yç±³ï¼‰/344 ==ã€‹Xç§’=0.0058*Yç±³ ==ã€‹å˜ç±³=å¾®ç
             -§’/58 
  85   2          if(succeed_flag==0)
  86   2             {
  87   3                  distance_data=0;                    //æ²¡æœ‰å›æ³¢åˆ™æ¸…é›¶
  88   3              test = !test;                       //æµ‹è¯•ç¯å˜åŒ–
  89   3                 }
  90   2      
  91   2           ///       distance[i]=distance_data; //å°†æµ‹é‡ç»“æœçš„æ•°æ®æ”¾å…¥ç¼“å†²åŒº
  92   2           ///        i++;
  93   2            ///  if(i==3)
  94   2          ///      {
  95   2          ///        distance_data=(distance[0]+distance[1]+distance[2]+distance[3])/4;
  96   2           ///        pai_xu();
  97   2           ///        distance_data=distance[1];
  98   2      
  99   2            
 100   2           a=distance_data;
 101   2             if(b==a) CONT_1=0;
 102   2             if(b!=a) CONT_1++;
 103   2             if(CONT_1>=3)
 104   2             { CONT_1=0;
 105   3              b=a;
 106   3              conversion(b);
 107   3            }       
 108   2          ///    i=0;
 109   2          ///   }      
 110   2         }
 111   1      }
 112          //***************************************************************
 113          //å¤–éƒ¨ä¸­æ–­0ï¼Œç”¨åšåˆ¤æ–­å›æ³¢ç”µå¹³
 114          INTO_()  interrupt 0   // å¤–éƒ¨ä¸­æ–­æ˜¯0å·
 115           {    
 116   1           outcomeH =TH1;    //å–å‡ºå®šæ—¶å™¨çš„å€¼
C51 COMPILER V9.01   HC_SR04                                                               09/18/2021 08:55:27 PAGE 3   

 117   1           outcomeL =TL1;    //å–å‡ºå®šæ—¶å™¨çš„å€¼
 118   1           succeed_flag=1;   //è‡³æˆåŠŸæµ‹é‡çš„æ ‡å¿—
 119   1           EX0=0;            //å…³é—­å¤–éƒ¨ä¸­æ–­
 120   1        }
 121          //****************************************************************
 122          //å®šæ—¶å™¨0ä¸­æ–­,ç”¨åšæ˜¾ç¤º
 123          timer0() interrupt 1  // å®šæ—¶å™¨0ä¸­æ–­æ˜¯1å·
 124             {
 125   1         TH0=0xfd; //å†™å…¥å®šæ—¶å™¨0åˆå§‹å€¼
 126   1         TL0=0x77;    
 127   1         switch(flag)   
 128   1            {case 0x00:P0=ge; P2=0xfd;flag++;break;
 129   2            case 0x01:P0=shi;P2=0xfe;flag++;break;
 130   2            case 0x02:P0=bai;P2=0xfb;flag=0;break;
 131   2            }
 132   1         }
 133          //*****************************************************************
 134          /*
 135          //å®šæ—¶å™¨1ä¸­æ–­,ç”¨åšè¶…å£°æ³¢æµ‹è·è®¡æ—¶
 136          timer1() interrupt 3  // å®šæ—¶å™¨0ä¸­æ–­æ˜¯1å·
 137              {
 138          TH1=0;
 139          TL1=0;
 140               }
 141          */
 142          //******************************************************************
 143          //æ˜¾ç¤ºæ•°æ®è½¬æ¢ç¨‹åº
 144          void conversion(uint temp_data)  
 145           {  
 146   1          uchar ge_data,shi_data,bai_data ;
 147   1          bai_data=temp_data/100 ;
 148   1          temp_data=temp_data%100;   //å–ä½™è¿ç®—
 149   1          shi_data=temp_data/10 ;
 150   1          temp_data=temp_data%10;   //å–ä½™è¿ç®—
 151   1          ge_data=temp_data;
 152   1      
 153   1          bai_data=SEG7[bai_data];
 154   1          shi_data=SEG7[shi_data];
 155   1          ge_data =SEG7[ge_data];
 156   1      
 157   1          EA=0;
 158   1          bai = bai_data;
 159   1          shi = shi_data;
 160   1          ge  = ge_data ; 
 161   1         EA=1;
 162   1       }
 163          //******************************************************************
 164          void delay_20us()
 165           {  uchar bt ;
 166   1          for(bt=0;bt<100;bt++);
 167   1       }
 168          /*
 169          void pai_xu()
 170            {  uint t;
 171            if (distance[0]>distance[1])
 172              {t=distance[0];distance[0]=distance[1];distance[1]=t;} /*äº¤æ¢å€¼
 173            if(distance[0]>distance[2])
 174              {t=distance[2];distance[2]=distance[0];distance[0]=t;} /*äº¤æ¢å€¼
 175            if(distance[1]>distance[2])
 176              {t=distance[1];distance[1]=distance[2];distance[2]=t;} /*äº¤æ¢å€¼   
 177              }
 178          */
C51 COMPILER V9.01   HC_SR04                                                               09/18/2021 08:55:27 PAGE 4   



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    356    ----
   CONSTANT SIZE    =     10    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     16       9
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
